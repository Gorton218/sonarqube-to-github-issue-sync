name: SonarCloud to GitHub Sync

on:
  workflow_call:
    inputs:
      sonar_project:
        description: "SonarCloud project key (e.g., 'my-org_my-project')"
        required: true
        type: string
      issue_types:
        description: "Comma-separated list of issue types to sync"
        required: false
        default: "BUG,VULNERABILITY,CODE_SMELL"
        type: string
      dry_run:
        description: "Preview changes without making modifications"
        required: false
        default: false
        type: boolean
      log_level:
        description: "Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)"
        required: false
        default: "INFO"
        type: string
      debug:
        description: "Enable debug logging"
        required: false
        default: false
        type: boolean
    secrets:
      SONAR_TOKEN:
        description: "SonarCloud personal access token"
        required: true
    #   GITHUB_TOKEN:
    #     description: "GitHub token (PAT or Actions token with issues:write)"
    #     required: true

jobs:
  sync:
    name: Run SonarCloud to GitHub sync
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Resolve workflow repository
        id: resolve
        shell: bash
        run: |
          # github.workflow_ref format: owner/repo/.github/workflows/name.yml@ref
          WORKFLOW_REF="${{ github.workflow_ref }}"
          REPO_PATH="${WORKFLOW_REF%%/.github/*}"
          REF_PART="${WORKFLOW_REF##*@}"
          echo action_repo: ${{ github.action_repository }}
          echo action_ref: ${{ github.action_ref }}
          # Trim refs/heads/ or refs/tags/
          CLEAN_REF="${REF_PART#refs/heads/}"
          CLEAN_REF="${CLEAN_REF#refs/tags/}"
          echo "repository=$REPO_PATH" >> "$GITHUB_OUTPUT"
          echo "ref=$CLEAN_REF" >> "$GITHUB_OUTPUT"

      - name: Checkout sync tool repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.action_repository }}
          ref: ${{ github.action_ref }}
          path: sync-tool

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('sync-tool/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install sync tool
        shell: bash
        working-directory: sync-tool
        run: |
          env
          ls -l
          pwd
          pip install --upgrade pip
          pip install .

      - name: Run sync
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          CMD=(sonarcloud-github-sync \
            --sonar-project "${{ inputs.sonar_project }}" \
            --github-repo "${{ github.repository }}" \
            --issue-types "${{ inputs.issue_types }}" \
            --log-level "${{ inputs.log_level }}")
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            CMD+=(--dry-run)
          fi
          if [ "${{ inputs.debug }}" = "true" ]; then
            CMD+=(--debug)
          fi
          echo "Running: ${CMD[*]}"
          "${CMD[@]}"
